ifndef TARGET_DIR
	$(error TARGET_DIR is not set)
endif
.SUFFIXES: .c .o .h .mk
.PHONY: .remove_link
.DEFAULT_GOAL := .remove_link
#################################################################################
#################### FUNCTIONS:
define getObjFileNameFromSrc
$(addprefix $(TARGET_LINK)/, $(patsubst %.c, %.o, $1))
endef
#################################################################################
#################### COMPILATION AUTOGENERATED VARIABLES:
SOURCES       = $(shell find "$(SRC_DIR)" -name "*.c";)
OBJECTS       = $(call getObjFileNameFromSrc,$(SOURCES))
TARGET_LINK   = $(notdir $(TARGET_DIR))
TARGET_DIRS   = $(sort $(dir $(OBJECTS)))

-include $(OBJECTS:.o=.mk)
.remove_link:
	rm $(TARGET_LINK)
#################################################################################
#################### STATIC PATTERN RULES:
$(TARGET_LINK)/%.o: %.c | $(TARGET_DIRS)
	$(COMPILE.c) -MM $< -MT $@ -MF $(@:.o=.mk)
	$(COMPILE.c) -o $@ $<
#################################################################################
#################### DIRECTORY GENERATION RULES:
$(TARGET_DIRS): %: | $(TARGET_LINK)
	mkdir -p $@

$(TARGET_LINK):
	ln -s $(TARGET_DIR) $@
