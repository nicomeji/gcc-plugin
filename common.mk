General description:
   This common.mk contains usefull rules to be reused for the project
compilation. It's design to be reused in diffetent paths, to work correctly two
main variables are needed:
      -> TARGET_DIR: This variable defines the location where all the
                     generated files should go. If this variable is not
                     setted, then a error is reported and make will stop.
      -> SRC_DIR: This variable defines the path where all the sources are
                  located. If this variable is not setted, make won't be
                  able to find any source, and consecuently won't compile
                  any binary; anyway, the funtions and rules define in this
                  will be available.
How it works:
   All the target files generated by rules define in this common.mk will be
placed in TARGET_DIR. To avoid using absolute paths a new variable,
TARGET_LINK, is created with the directory name of TARGET_DIR
ifndef TARGET_DIR
	$(error TARGET_DIR is not set)
endif
.SUFFIXES: .c .o .h .mk
.PHONY: post_build
.DEFAULT_GOAL := post_build
#################################################################################
#################### FUNCTIONS:
define getObjFileNameFromSrc
$(addprefix $(TARGET_LINK)/, $(patsubst %.c, %.o, $1))
endef
#################################################################################
#################### COMPILATION AUTOGENERATED VARIABLES:
SOURCES       = $(shell find "$(SRC_DIR)" -name "*.c";)
OBJECTS       = $(call getObjFileNameFromSrc,$(SOURCES))
TARGET_LINK   = $(notdir $(TARGET_DIR))
TARGET_DIRS   = $(sort $(dir $(OBJECTS)))

-include $(OBJECTS:.o=.mk)
post_build:
	rm $(TARGET_LINK)
#################################################################################
#################### STATIC PATTERN RULES:
$(TARGET_LINK)/%.o: %.c | $(TARGET_DIRS)
	$(COMPILE.c) -MM $< -MT $@ -MF $(@:.o=.mk)
	$(COMPILE.c) -o $@ $<
#################################################################################
#################### DIRECTORY GENERATION RULES:
$(TARGET_DIRS): %: | $(TARGET_LINK)
	mkdir -p $@

$(TARGET_LINK):
	ln -s "$(TARGET_DIR)" $@
